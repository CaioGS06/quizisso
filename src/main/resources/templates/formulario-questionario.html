<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <title th:text="${questionario != null ? 'Quizisso - Editar Questionário' : 'Quizisso - Criar Questionário'}">Quizisso
    - Questionário</title>
  <th:block th:replace="~{fragments/cabecalho :: head}"></th:block>
</head>

<body>
  <th:block th:replace="~{fragments/cabecalho :: cabecalho}"></th:block>

  <main class="conteudo-principal">
    <div class="container-questionario">
      <div class="header-questionario">
        <button class="botao-voltar" onclick="window.location.href='/meus-questionarios'">
          <i class="ti ti-arrow-left"></i>
          Voltar
        </button>
        <div class="info-questionario">
          <input type="text" class="campo-titulo-edicao" th:value="${questionario != null ? questionario.titulo : ''}"
            placeholder="Título do Questionário">
          <div class="banner-seletor">
            <div class="banner-preview" onclick="abrirModalSelecionarBanner()">
              <img
                th:src="${questionario != null ? '/img/banner' + questionario.bannerId + '.jpg' : '/img/banner0.jpg'}"
                alt="Banner selecionado" id="bannerPreview">
              <div class="banner-overlay">
                <i class="ti ti-photo"></i>
                <span th:text="${questionario != null ? 'Trocar Banner' : 'Selecionar Banner'}">Selecionar Banner</span>
              </div>
            </div>
          </div>
          <textarea class="campo-descricao-edicao" th:text="${questionario != null ? questionario.descricao : ''}"
            placeholder="Descrição do questionário (opcional)" rows="3"></textarea>
          <button th:if="${questionario != null}" class="botao-excluir-questionario"
            onclick="abrirModalExcluirQuestionario()">
            <i class="ti ti-trash"></i>
            Excluir Questionário
          </button>
        </div>
      </div>

      <form class="formulario-questionario" th:attr="data-modo=${questionario != null ? 'editar' : 'criar'},
                     data-questionario-id=${questionario != null ? questionario.id : ''}">

        <!-- Questões pré-carregadas (modo edição) -->
        <th:block th:if="${questionario != null}">
          <div class="questao-card edicao" th:each="item, iterStat : ${questionario.listaItens}">
            <div class="questao-header">
              <span class="questao-numero" th:text="'Questão ' + ${iterStat.count}">Questão 1</span>
              <div class="questao-controles">
                <div class="campo-pontuacao-container">
                  <label>Pontuação:</label>
                  <input type="number" class="campo-pontuacao" th:value="${item.pontuacaoMaxima}" min="0" step="0.5"
                    value="1.0" onchange="atualizarPontuacaoTotal()">
                  <span>pts</span>
                </div>
                <select class="select-tipo-questao" onchange="trocarTipoQuestao(this)">
                  <option value="alternativa" th:selected="${item.getTipo() == 'ALTERNATIVA'}">Alternativa</option>
                  <option value="dissertativa" th:selected="${item.getTipo() == 'DISSERTATIVA'}">Dissertativa</option>
                </select>
                <button type="button" class="botao-remover-questao" onclick="removerQuestao(this)">
                  <i class="ti ti-x"></i>
                </button>
              </div>
            </div>
            <input type="text" class="campo-enunciado" th:value="${item.enunciado}" placeholder="Digite o enunciado...">

            <!-- Alternativas (apenas para ItemAlternativa) -->
            <div class="alternativas-edicao" th:if="${item.tipo == 'ALTERNATIVA'}">
              <div class="alternativa-edicao" th:each="alternativa, altIterStat : ${item.alternativas}">
                <input type="radio" th:name="'correta' + ${iterStat.count}" th:checked="${alternativa.estaCorreta}">
                <input type="text" class="campo-alternativa" th:value="${alternativa.descricao}"
                  placeholder="Digite a alternativa">
                <button type="button" class="botao-remover-alternativa" onclick="removerAlternativa(this)">
                  <i class="ti ti-x"></i>
                </button>
              </div>
              <button type="button" class="botao-adicionar-alternativa" onclick="adicionarAlternativa(this)">
                <i class="ti ti-plus"></i>
                Adicionar Alternativa
              </button>
            </div>

            <!-- Gabarito (apenas para ItemDissertativa) -->
            <textarea class="campo-gabarito" th:if="${item.tipo == 'DISSERTATIVA'}"
              placeholder="Digite o gabarito/resposta esperada..." rows="4" th:text="${item.gabarito}"></textarea>
          </div>
        </th:block>

        <!-- Mensagem informativa (modo criar) -->
        <div th:if="${questionario == null}" class="info-criacao">
          <p>Adicione questões ao seu questionário clicando no botão abaixo.</p>
        </div>

        <div class="resumo-pontuacao">
          <i class="ti ti-calculator"></i>
          <span>Pontuação Total: <strong id="pontuacaoTotal">0.0</strong> pontos</span>
        </div>

        <div class="acoes-formulario">
          <button type="button" class="botao-adicionar-questao" onclick="adicionarQuestao()">
            <i class="ti ti-plus"></i>
            Adicionar Questão
          </button>
          <button type="submit" class="botao-salvar">
            <i class="ti ti-device-floppy"></i>
            <span th:text="${questionario != null ? 'Salvar Alterações' : 'Criar Questionário'}">Salvar</span>
          </button>
        </div>
      </form>
    </div>
  </main>

  <!-- Modal de Seleção de Banner -->
  <div id="modalSelecionarBanner" class="modal">
    <div class="modal-conteudo">
      <div class="modal-header">
        <h3>Selecionar Banner do Questionário</h3>
        <button class="botao-fechar-modal" onclick="fecharModalSelecionarBanner()">
          <i class="ti ti-x"></i>
        </button>
      </div>
      <div class="modal-corpo">
        <p>Escolha um banner para o questionário:</p>
        <div class="grade-fotos">
          <label class="opcao-foto" th:each="banner : ${banners}">
            <input type="radio" name="bannerId" th:value="${banner.id}"
              th:checked="${questionario != null ? banner.id == questionario.bannerId : banner.id == 0}"
              onclick="atualizarBannerPreview(this.value)">
            <img th:src="@{'/img/' + ${banner.nomeArquivo}}" th:alt="${banner.descricao}">
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="botao-cancelar" onclick="fecharModalSelecionarBanner()">Cancelar</button>
        <button type="button" class="botao-confirmar" onclick="confirmarBanner()">
          <i class="ti ti-check"></i>
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação de Exclusão (apenas modo edição) -->
  <div th:if="${questionario != null}" id="modalExcluirQuestionario" class="modal">
    <div class="modal-conteudo">
      <div class="modal-header">
        <h3>Confirmar Exclusão</h3>
        <button class="botao-fechar-modal" onclick="fecharModalExcluirQuestionario()">
          <i class="ti ti-x"></i>
        </button>
      </div>
      <div class="modal-corpo">
        <p>Tem certeza que deseja excluir este questionário?</p>
        <p class="modal-aviso">Esta ação não pode ser desfeita.</p>
      </div>
      <div class="modal-footer">
        <button class="botao-cancelar" onclick="fecharModalExcluirQuestionario()">Cancelar</button>
        <button class="botao-confirmar-excluir" onclick="confirmarExclusaoQuestionario()">
          <i class="ti ti-trash"></i>
          Excluir
        </button>
      </div>
    </div>
  </div>

  <th:block th:replace="~{fragments/cabecalho :: scripts}"></th:block>
</body>

</html>